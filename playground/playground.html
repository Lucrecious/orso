<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Orso Interpreter Demo</title>
  </head>
  <style>
    .readonly {
        display: block;
        font-family: monospace;
        padding: 10px;
        background-color: #f4f4f4;
        border: 1px solid #ccc;
        margin: 0;
        white-space: pre-wrap;
    }
  </style>
  <body>
    <h1>Orso Interpreter Demo</h1>
    <textarea id="input" rows="10" cols="50">print_expr "Hello, World!";</textarea>
    <button onclick="runCode()">Run</button>
    <pre><code id="output" class="readonly">
    </code></pre>
    
    <script src="./orso.js"></script>
    <script>
        function writeFunction(chars) {
            var string = Module.UTF8ToString(chars)
            document.getElementById("output").textContent += string;
        }

        function errorFunction(error, line, message) {
            document.getElementById("output").textContent += `Error at line ${line}: ${Module.UTF8ToString(message)}\n`
        }

        let api = {
        }

        Module.onRuntimeInitialized = async () => {
            api = {
                interpreter_new: Module.cwrap("interpreter_new", "number", ["number", "number"]),
                interpreter_free: Module.cwrap("interpreter_free", "null", ["number"]),
                interpreter_run: Module.cwrap("interpreter_run", "null", ["number", "string"]),
            };
        };
        function runCode() {
            let writeFunctionPtr = Module.addFunction(writeFunction, 'vi');
            let errorFunctionPtr = Module.addFunction(errorFunction, 'viii');
            let interpreter = api.interpreter_new(writeFunctionPtr, errorFunctionPtr)

            document.getElementById("output").innerText = "";

            let inputRaw = document.getElementById("input").value;
            let asciiText = unescape(encodeURIComponent(inputRaw))
            api.interpreter_run(interpreter, asciiText)

            api.interpreter_free(interpreter);

            Module.removeFunction(writeFunctionPtr);
            Module.removeFunction(errorFunctionPtr);
        }
    </script>
  </body>
</html>
